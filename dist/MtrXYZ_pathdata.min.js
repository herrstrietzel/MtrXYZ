!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MtrXYZ=t.MtrXYZ||{})}(this,(function(t){"use strict";function e(t,e=-1){let a=!("auto"!=e||!t[0].hasOwnProperty("decimals"));for(let s=0,l=t.length;s<l;s++){let l=t[s];(e>-1||a)&&(e=a?l.decimals:e,t[s].values=l.values.map((t=>+t.toFixed(e))))}return t}function a(t,e=-1){let a=t[0].values,s=a[0],l=a[1],r=s,n=l;for(let a=1,u=t.length;a<u;a++){let u=t[a],{type:h,values:o}=u,i=h.toUpperCase();if(h!=i)switch(h=i,u.type=h,i){case"A":o[5]=+(o[5]+s),o[6]=+(o[6]+l);break;case"V":o[0]=+(o[0]+l);break;case"H":o[0]=+(o[0]+s);break;case"M":r=+o[0]+s,n=+o[1]+l;default:if(o.length)for(let t=0;t<o.length;t++)o[t]=o[t]+(t%2?l:s)}let c=o.length;switch(h){case"Z":s=+r,l=+n;break;case"H":s=o[0];break;case"V":l=o[0];break;case"M":r=o[c-2],n=o[c-1];default:s=o[c-2],l=o[c-1]}e>-1&&(u.values=u.values.map((t=>+t.toFixed(e))))}return t}function s(t,e,a=1){const s=2*Math.PI;let[l,r,n,u,h,o,i]=e;if(0===l||0===r)return[];let c=n?n*s/360:0,y=c?Math.sin(c):0,p=c?Math.cos(c):1,f=p*(t.x-o)/2+y*(t.y-i)/2,v=-y*(t.x-o)/2+p*(t.y-i)/2;if(0===f&&0===v)return[];l=Math.abs(l),r=Math.abs(r);let M=f*f/(l*l)+v*v/(r*r);if(M>1){let t=Math.sqrt(M);l*=t,r*=t}let x=l*l,d=l===r?x:r*r,g=f*f,b=v*v,m=x*d-x*b-d*g;m<=0?m=0:(m/=x*b+d*g,m=Math.sqrt(m)*(u===h?-1:1));let P=m?m*l/r*v:0,A=m?m*-r/l*f:0,w=p*P-y*A+(t.x+o)/2,k=y*P+p*A+(t.y+i)/2,q=(f-P)/l,T=(v-A)/r,I=(-f-P)/l,Z=(-v-A)/r;const $=(t,e,a,s)=>{let l=+(t*a+e*s).toFixed(9);return 1===l||-1===l?1===l?0:Math.PI:(l=l>1?1:l<-1?-1:l,(t*s-e*a<0?-1:1)*Math.acos(l))};let D=$(1,0,q,T),C=$(q,T,I,Z);0===h&&C>0?C-=2*Math.PI:1===h&&C<0&&(C+=2*Math.PI);let S=(+(Math.abs(C)/(s/4)).toFixed(0)||1)*a;C/=S;let X=[];const Y=1.5707963267948966,F=.551785;let L=C===Y?F:C===-Y?-F:4/3*Math.tan(C/4),j=C?Math.cos(C):1,z=C?Math.sin(C):0;const Q=(t,e,a,s,l)=>{let r=t!=e?Math.cos(t):s,n=t!=e?Math.sin(t):l,u=Math.cos(t+e),h=Math.sin(t+e);return[{x:r-n*a,y:n+r*a},{x:u+h*a,y:h-u*a},{x:u,y:h}]};for(let t=0;t<S;t++){let t={type:"C",values:[]};Q(D,C,L,j,z).forEach((e=>{let a=e.x*l,s=e.y*r;t.values.push(p*a-y*s+w,y*a+p*s+k)})),X.push(t),D+=C}return X}const{abs:l,acos:r,atan:n,atan2:u,cos:h,sin:o,log:i,max:c,min:y,sqrt:p,tan:f,PI:v,pow:M}=Math;MtrXYZ.Mtx.prototype.transformPathData=function(t,e=8){let a=MtrXYZ.transformPathData(t,this.matrix,this.perspectiveOrigin,this.perspective,e);return this.ptsT=a,a},t.convertPathData=function(t,{normalize:l=null,optimize:r=1,toAbsolute:n=!0,toRelative:u=!1,quadraticToCubic:h=!1,lineToCubic:o=!1,toLonghands:i=!0,toShorthands:c=!1,arcToCubic:y=!1,arcParam:p=!1,arcAccuracy:f=1,optimizeOrder:v=!1,reorderSub:M=!1,simplify:x=!1,cubicToQuadratic:d=!1,cubicToQuadraticPrecision:g=.1,decimals:b=-1,cubicToArcs:m=!1}={}){return!0===l&&(n=!0,i=!0,y=!0,c=!1),t=JSON.parse(JSON.stringify(t)),n&&(t=a(t)),i&&(t=function(t,e=-1,s=!0){let l;if(s){let e=t.map((t=>t.type)).join(""),a=/[hstv]/gi.test(e);if(l=/[astvqmhlc]/g.test(e),!a)return t}t=s&&l?a(t,e):t;let r=[],n={type:"M",values:t[0].values};r.push(n);for(let a=1,s=t.length;a<s;a++){let s,l,u,h,o,i,c,y,p=t[a],{type:f,values:v}=p,M=v.length,x=n.values,d=x.length,[g,b]=[v[M-2],v[M-1]],[m,P]=[x[d-2],x[d-1]];switch(f){case"H":n={type:"L",values:[v[0],P]};break;case"V":n={type:"L",values:[m,v[0]]};break;case"T":[s,l]=[x[0],x[1]],[m,P]=[x[d-2],x[d-1]],u=m+(m-s),h=P+(P-l),n={type:"Q",values:[u,h,g,b]};break;case"S":[s,l]=[x[0],x[1]],[c,y]=d>2?[x[2],x[3]]:[x[0],x[1]],[m,P]=[x[d-2],x[d-1]],u=2*m-c,h=2*P-y,o=v[0],i=v[1],n={type:"C",values:[u,h,o,i,g,b]};break;default:n={type:f,values:v}}e>-1&&(n.values=n.values.map((t=>+t.toFixed(e)))),r.push(n)}return r}(t,-1,!1)),y&&(t=function(t,{arcAccuracy:e=1}={}){let a=[t[0]];for(let l=1,r=t.length;l<r;l++){let r=t[l],n=t[l-1].values,u=n.length,h={x:n[u-2],y:n[u-1]};if("A"===r.type){s(h,r.values,e).forEach((t=>{a.push(t)}))}else a.push(r)}return a}(t)),c&&(t=function(t,e=-1,s=!0){let l;if(s){let e=t.map((t=>t.type)).join("");l=/[astvqmhlc]/g.test(e)}t=s&&l?a(t,e):t;let r={type:"M",values:t[0].values};t[0].decimals&&(r.decimals=t[0].decimals);let n,u=[r],h={x:t[0].values[0],y:t[0].values[1]},o=.01;for(let a=1,s=t.length;a<s;a++){let s=t[a],{type:l,values:i}=s,c=i.slice(-2),y=t[a-1],p=y.type;n={x:c[0],y:c[1]};let f,v,M,x,d={x:i[0],y:i[1]},g=Math.abs(n.x-h.x),b=Math.abs(n.y-h.y),m=(g+b)/2*o;switch(l){case"L":r=0===b||b<m&&g>m?{type:"H",values:[i[0]]}:0===g||b>m&&g<m?{type:"V",values:[i[1]]}:s;break;case"Q":if("Q"!==p){h={x:c[0],y:c[1]},u.push(s);continue}let t={x:y.values[0],y:y.values[1]};x={x:2*h.x-t.x,y:2*h.y-t.y},f=Math.abs(d.x-x.x),v=Math.abs(d.y-x.y),M=(f+v)/2,r=M<m?{type:"T",values:[n.x,n.y]}:s;break;case"C":let e={x:i[2],y:i[3]};if("C"!==p){u.push(s),h={x:c[0],y:c[1]};continue}let a={x:y.values[2],y:y.values[3]};x={x:2*h.x-a.x,y:2*h.y-a.y},f=Math.abs(d.x-x.x),v=Math.abs(d.y-x.y),M=(f+v)/2,r=M<m?{type:"S",values:[e.x,e.y,n.x,n.y]}:s;break;default:r={type:l,values:i}}(s.decimals||0===s.decimals)&&(r.decimals=s.decimals),e>-1&&(r.values=r.values.map((t=>+t.toFixed(e)))),h={x:c[0],y:c[1]},u.push(r)}return u}(t)),u&&(t=function(t,e=-1){e>=0&&(t[0].values=t[0].values.map((t=>+t.toFixed(e))));let a=t[0].values,s=a[0],l=a[1],r=s,n=l;for(let a=1,u=t.length;a<u;a++){let u=t[a];e>=0&&u.values.length&&(u.values=u.values.map((t=>+t.toFixed(e))));let{type:h,values:o}=u,i=h.toLowerCase();if(h!=i)switch(h=i,u.type=h,i){case"a":o[5]=+(o[5]-s),o[6]=+(o[6]-l);break;case"v":o[0]=+(o[0]-l);break;case"m":r=o[0],n=o[1];default:if(o.length)for(let t=0;t<o.length;t++)o[t]=o[t]-(t%2?l:s)}else"m"==h&&(r=o[0]+s,n=o[1]+l);let c=o.length;switch(h){case"z":s=r,l=n;break;case"h":s+=o[c-1];break;case"v":l+=o[c-1];break;default:s+=o[c-2],l+=o[c-1]}e>-1&&(u.values=u.values.map((t=>+t.toFixed(e))))}return t}(t)),-1!==b&&(t=e(t,b)),t},t.parse=function(t,e=!0){e="log";const a={77:2,109:2,65:7,97:7,67:6,99:6,72:1,104:1,76:2,108:2,81:4,113:4,83:4,115:4,84:2,116:2,86:1,118:1,90:0,122:0},s=new Set([77,109,65,97,67,99,72,104,76,108,81,113,83,115,84,116,86,118,90,122]),l=new Set([5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279]);let r,n=0,u=t.length,h="",o=[],i=-1,c="",y=!1,p=!1,f=0,v=0,M=0,x=!1,d=!1,g=!1,b=!1,m=!1,P=new Set(["m","c","q","l","a","t","s","v","h"]),A=new Set(["t","s","v","h","T","S","V","H"]),w=new Set(["t","q","T","Q"]),k=[];function q(){x&&("M"===h?h="L":"m"===h&&(h="l"),o.push({type:h,values:[]}),i++,v=0,x=!1)}function T(t=!1){(t?f>0:""!==c)&&(e&&-1===i&&(r="Pathdata must start with M command",k.push(r),h="M",o.push({type:h,values:[]}),M=2,v=0,i++),"A"===h||"a"===h?(c=function(){let t=c.length,e=!1;3===v&&2===t||4===v&&t>1?(c=[+c[0],+c[1]],e=!0,v++):3===v&&t>3&&(c=[+c[0],+c[1],+c.substring(2)],e=!0,v+=2);return e?c:[+c]}(),o[i].values.push(...c)):(e&&c[1]&&"."!==c[1]&&"0"===c[0]&&(r="Leading zeros not valid: "+c,k.push(r)),o[i].values.push(+c)),v++,c="",f=0,x=v>=M)}function I(){if(e){let t=i>0?o[i]:0,e=t?t.values.length:0;if(e&&e<M||e&&e>M||("z"===h||"Z"===h)&&e>0){r=`Pathdata commands in "${h}" (segment index: ${i}) don't match allowed number of values: ${M-e}/${M}`,k.push(r)}}}for(;n<u;){let e=t[n],r=t.charCodeAt(n);if($=r,s.has($)){""!==c&&(o[i].values.push(+c),v++,c=""),I(),h=e,M=a[r];let t="M"===h||"m"===h;i>0&&("z"===o[i].type||"Z"===o[i].type)&&!t&&(o.push({type:"m",values:[0,0]}),i++),o.push({type:h,values:[]}),i++,d||(d=P.has(h)),b||(b=A.has(h)),m||(m=w.has(h)),g||(g="a"===h||"A"===h),p=!1,f=0,v=0,x=!1,n++}else if(10===(Z=r)||13===Z||8232===Z||8233===Z||44===Z||44===Z||32===Z||9===Z||11===Z||12===Z||160===Z||Z>=5760&&l.has(Z)>=0)T(),p=!0,y=!1,n++;else{if(n===u-1){c+=e,T(),p=!1,y=!1,I();break}if(!y&&!p&&45===r||!y&&46===r){let t=46===r;T(t),q(),t&&f++}else q();c+=e,y=69===r||101===r,p=!1,n++}}var Z,$;return I(),e&&k.length&&(r="Invalid path data:\n"+k.join("\n"),console.log(r)),o[0].type="M",{pathData:o,hasRelatives:d,hasShorthands:b,hasQuadratics:m,hasArcs:g}},t.pathDataToD=function(t,e=1){let a=e>1,s=!a;"l"===t[1].type&&s&&(t[0].type="m");let l="";l=a?`${t[0].type} ${t[0].values.join(" ")}\n`:`${t[0].type}${t[0].values.join(" ")}`;for(let e=1,r=t.length;e<r;e++){let r=t[e-1],n=t[e],{type:u,values:h}=n;if(!s||"A"!==u&&"a"!==u||(h=[h[0],h[1],h[2],`${h[3]}${h[4]}${h[5]}`,h[6]]),u=r.type===n.type&&"m"!==n.type.toLowerCase()&&s||("m"===r.type&&"l"===n.type||"M"===r.type&&"l"===n.type||"M"===r.type&&"L"===n.type)&&s?" ":n.type,s){let t="",e=!1;for(let a=0,s=h.length;a<s;a++){let s=h[a],l=s.toString(),r=l.includes(".")&&Math.abs(s)<1;r&&e&&(l=l.replace(/^0\./,".")),!(a>0)||e&&r||(t+=" "),t+=l,e=r}l+=`${u}${t}`}else l+=a?`${u} ${h.join(" ")}\n`:`${u}${h.join(" ")}`}return s&&(l=l.replace(/ 0\./g," .").replace(/ -/g,"-").replace(/-0\./g,"-.").replace(/Z/g,"z")),l},t.roundPathData=e,t.svgArcToCenterParam=function(t,e,a,s,r,n,i,c,y){const f=(t,e,a,s)=>u(s-e,a-t);let M={cx:0,cy:0,rx:a=l(a),ry:s=l(s),startAngle:0,endAngle:0,deltaAngle:0,clockwise:i};if(0==a||0==s)throw Error("rx and ry can not be 0");if(a===s){let a=Math.abs(c-t),s=Math.abs(y-e),l=a,r=Math.min(t,c),n=Math.min(e,y),u=.5*Math.PI;if(0===a&&s||0===s&&a)return l=0===a&&s?s/2:a/2,M.rx=l,M.ry=l,0===a&&s?(M.cx=t,M.cy=n+s/2,M.startAngle=e>y?u:-u,M.endAngle=e>y?-u:u,M.deltaAngle=i?Math.PI:-Math.PI):0===s&&a&&(M.cx=r+a/2,M.cy=e,M.startAngle=t>c?Math.PI:0,M.endAngle=t>c?-Math.PI:Math.PI,M.deltaAngle=i?Math.PI:-Math.PI),M}let x,d,g=a===s?0:r*v/180,b=g?o(g):0,m=g?h(g):1,P=(t-c)/2,A=(e-y)/2,w=(t+c)/2,k=(e+y)/2,q=g?m*P+b*A:P,T=g?m*A-b*P:A,I=q*q/(a*a)+T*T/(s*s);I>1&&(a*=p(I),s*=p(I),M.rx=a,M.ry=s);let Z=a*s,$=a*T,D=s*q,C=$*$+D*D;if(!C)throw Error("start point can not be same as end point");let S=p(l((Z*Z-C)/C));n==i&&(S=-S);let X=S*$/s,Y=-S*D/a;x=g?m*X-b*Y+w:w+X,d=g?b*X+m*Y+k:k+Y,M.cy=d,M.cx=x;let F=f(x,d,t,e),L=f(x,d,c,y);!i&&L>F&&(L-=2*Math.PI),i&&F>L&&(L=L<=0?L+2*Math.PI:L);let j=L-F;return M.startAngle=F,M.endAngle=L,M.deltaAngle=j,M},t.transformPathData=function(t,e,a={x:0,y:0},s=1/0,l=-1){t=Array.isArray(t)?t:MtrXYZ.parse(t).pathData,t=MtrXYZ.convertPathData(t,{toAbsolute:!0,toLonghands:!0});let r=[],n=16===Object.values(e).length,u=!1;if(n&&(u=MtrXYZ.canFlattenTo2D(e,s)),u&&(n=!1,e=MtrXYZ.flattenTo2D(e,s)),n){let e={arcToCubic:!0};t=MtrXYZ.convertPathData(t,e)}return"100100"===[e.a,e.b,e.c,e.d,e.e,e.f].map((t=>+t.toFixed(1))).join("")?t:(t.forEach(((l,u)=>{let{type:h,values:o}=l,i=h.toLowerCase(),c=(u>0?t[u-1]:t[u]).values,y=c.length,p={x:c[y-2],y:c[y-1]};o[o.length-2],o[o.length-1];let f={type:h,values:[]};if("a"===i)f=((t,e,a)=>{let[s,l,r,n,u,h,o]=e,i=MtrXYZ.svgArcToCenterParam(t.x,t.y,e[0],e[1],r,n,u,h,o);({rx:s,ry:l}=i);let{a:c,b:y,c:p,d:f,e:v,f:M}=a,x=((t,e,a,s)=>{const l=Math.PI/180,r=1e-7;var n=Math.cos(a*l),u=Math.sin(a*l),h=[t*(s.a*n+s.c*u),t*(s.b*n+s.d*u),e*(-s.a*u+s.c*n),e*(-s.b*u+s.d*n)],o=h[0]*h[0]+h[2]*h[2],i=h[1]*h[1]+h[3]*h[3],c=Math.sqrt(((h[0]-h[3])*(h[0]-h[3])+(h[2]+h[1])*(h[2]+h[1]))*((h[0]+h[3])*(h[0]+h[3])+(h[2]-h[1])*(h[2]-h[1]))),y=(o+i)/2;if(c<=r)return{rx:t=e=Math.sqrt(y),ry:e,ax:a=0};if(Math.abs(c-Math.abs(o-i))<=r)return{rx:t=Math.sqrt(o),ry:e=Math.sqrt(i),ax:a=0};var p=h[0]*h[1]+h[2]*h[3],f=y+c/2,v=y-c/2;return Math.abs(p)<=r&&Math.abs(f-i)<=r?(a=0,{rx:t=Math.sqrt(v),ry:e=Math.sqrt(f),ax:a}):((a=Math.atan(Math.abs(p)>Math.abs(f-i)?(f-o)/p:p/(f-i))/l)>=0?(t=Math.sqrt(f),e=Math.sqrt(v)):(a+=90,t=Math.sqrt(v),e=Math.sqrt(f)),{rx:t,ry:e,ax:a})})(s,l,r,a),d=MtrXYZ.transformPoint2D({x:h,y:o},a),g=c**2+y**2,b=Math.sqrt(g);return(b<0||(c*f-p*y)/b<0)&&(u=0===u?1:0),{type:"A",values:[x.rx,x.ry,x.ax,n,u,d.x,d.y]}})(p,o,e);else if(o.length)for(let t=0;t<o.length;t+=2){let r=n?MtrXYZ.transformPoint3D({x:l.values[t],y:l.values[t+1]},e,a,s):MtrXYZ.transformPoint2D({x:l.values[t],y:l.values[t+1]},e);f.values[t]=r.x,f.values[t+1]=r.y}r.push(f)})),r)}}));
