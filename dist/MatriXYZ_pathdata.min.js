!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MatriXYZ=t.MatriXYZ||{})}(this,(function(t){"use strict";function e(t,e=-1){let a=!("auto"!=e||!t[0].hasOwnProperty("decimals"));for(let s=0,l=t.length;s<l;s++){let l=t[s];(e>-1||a)&&(e=a?l.decimals:e,t[s].values=l.values.map((t=>+t.toFixed(e))))}return t}function a(t,e=-1){let a=t[0].values,s=a[0],l=a[1],r=s,n=l;for(let a=1,i=t.length;a<i;a++){let i=t[a],{type:u,values:h}=i,o=u.toUpperCase();if(u!=o)switch(u=o,i.type=u,o){case"A":h[5]=+(h[5]+s),h[6]=+(h[6]+l);break;case"V":h[0]=+(h[0]+l);break;case"H":h[0]=+(h[0]+s);break;case"M":r=+h[0]+s,n=+h[1]+l;default:if(h.length)for(let t=0;t<h.length;t++)h[t]=h[t]+(t%2?l:s)}let c=h.length;switch(u){case"Z":s=+r,l=+n;break;case"H":s=h[0];break;case"V":l=h[0];break;case"M":r=h[c-2],n=h[c-1];default:s=h[c-2],l=h[c-1]}e>-1&&(i.values=i.values.map((t=>+t.toFixed(e))))}return t}function s(t,e,a=1){const s=2*Math.PI;let[l,r,n,i,u,h,o]=e;if(0===l||0===r)return[];let c=n?n*s/360:0,y=c?Math.sin(c):0,p=c?Math.cos(c):1,f=p*(t.x-h)/2+y*(t.y-o)/2,v=-y*(t.x-h)/2+p*(t.y-o)/2;if(0===f&&0===v)return[];l=Math.abs(l),r=Math.abs(r);let M=f*f/(l*l)+v*v/(r*r);if(M>1){let t=Math.sqrt(M);l*=t,r*=t}let x=l*l,d=l===r?x:r*r,g=f*f,b=v*v,m=x*d-x*b-d*g;m<=0?m=0:(m/=x*b+d*g,m=Math.sqrt(m)*(i===u?-1:1));let P=m?m*l/r*v:0,A=m?m*-r/l*f:0,w=p*P-y*A+(t.x+h)/2,k=y*P+p*A+(t.y+o)/2,q=(f-P)/l,T=(v-A)/r,I=(-f-P)/l,Z=(-v-A)/r;const $=(t,e,a,s)=>{let l=+(t*a+e*s).toFixed(9);return 1===l||-1===l?1===l?0:Math.PI:(l=l>1?1:l<-1?-1:l,(t*s-e*a<0?-1:1)*Math.acos(l))};let D=$(1,0,q,T),C=$(q,T,I,Z);0===u&&C>0?C-=2*Math.PI:1===u&&C<0&&(C+=2*Math.PI);let S=(+(Math.abs(C)/(s/4)).toFixed(0)||1)*a;C/=S;let X=[];const Y=1.5707963267948966,F=.551785;let L=C===Y?F:C===-Y?-F:4/3*Math.tan(C/4),j=C?Math.cos(C):1,z=C?Math.sin(C):0;const Q=(t,e,a,s,l)=>{let r=t!=e?Math.cos(t):s,n=t!=e?Math.sin(t):l,i=Math.cos(t+e),u=Math.sin(t+e);return[{x:r-n*a,y:n+r*a},{x:i+u*a,y:u-i*a},{x:i,y:u}]};for(let t=0;t<S;t++){let t={type:"C",values:[]};Q(D,C,L,j,z).forEach((e=>{let a=e.x*l,s=e.y*r;t.values.push(p*a-y*s+w,y*a+p*s+k)})),X.push(t),D+=C}return X}const{abs:l,acos:r,atan:n,atan2:i,cos:u,sin:h,log:o,max:c,min:y,sqrt:p,tan:f,PI:v,pow:M}=Math;MatriXYZ.Mtx.prototype.transformPathData=function(t,e=8){let a=MatriXYZ.transformPathData(t,this.matrix,this.perspectiveOrigin,this.perspective,e);return this.ptsT=a,a},t.convertPathData=function(t,{normalize:l=null,optimize:r=1,toAbsolute:n=!0,toRelative:i=!1,quadraticToCubic:u=!1,lineToCubic:h=!1,toLonghands:o=!0,toShorthands:c=!1,arcToCubic:y=!1,arcParam:p=!1,arcAccuracy:f=1,optimizeOrder:v=!1,reorderSub:M=!1,simplify:x=!1,cubicToQuadratic:d=!1,cubicToQuadraticPrecision:g=.1,decimals:b=-1,cubicToArcs:m=!1}={}){return!0===l&&(n=!0,o=!0,y=!0,c=!1),t=JSON.parse(JSON.stringify(t)),n&&(t=a(t)),o&&(t=function(t,e=-1,s=!0){let l;if(s){let e=t.map((t=>t.type)).join(""),a=/[hstv]/gi.test(e);if(l=/[astvqmhlc]/g.test(e),!a)return t}t=s&&l?a(t,e):t;let r=[],n={type:"M",values:t[0].values};r.push(n);for(let a=1,s=t.length;a<s;a++){let s,l,i,u,h,o,c,y,p=t[a],{type:f,values:v}=p,M=v.length,x=n.values,d=x.length,[g,b]=[v[M-2],v[M-1]],[m,P]=[x[d-2],x[d-1]];switch(f){case"H":n={type:"L",values:[v[0],P]};break;case"V":n={type:"L",values:[m,v[0]]};break;case"T":[s,l]=[x[0],x[1]],[m,P]=[x[d-2],x[d-1]],i=m+(m-s),u=P+(P-l),n={type:"Q",values:[i,u,g,b]};break;case"S":[s,l]=[x[0],x[1]],[c,y]=d>2?[x[2],x[3]]:[x[0],x[1]],[m,P]=[x[d-2],x[d-1]],i=2*m-c,u=2*P-y,h=v[0],o=v[1],n={type:"C",values:[i,u,h,o,g,b]};break;default:n={type:f,values:v}}e>-1&&(n.values=n.values.map((t=>+t.toFixed(e)))),r.push(n)}return r}(t,-1,!1)),y&&(t=function(t,{arcAccuracy:e=1}={}){let a=[t[0]];for(let l=1,r=t.length;l<r;l++){let r=t[l],n=t[l-1].values,i=n.length,u={x:n[i-2],y:n[i-1]};if("A"===r.type){s(u,r.values,e).forEach((t=>{a.push(t)}))}else a.push(r)}return a}(t)),c&&(t=function(t,e=-1,s=!0){let l;if(s){let e=t.map((t=>t.type)).join("");l=/[astvqmhlc]/g.test(e)}t=s&&l?a(t,e):t;let r={type:"M",values:t[0].values};t[0].decimals&&(r.decimals=t[0].decimals);let n,i=[r],u={x:t[0].values[0],y:t[0].values[1]},h=.01;for(let a=1,s=t.length;a<s;a++){let s=t[a],{type:l,values:o}=s,c=o.slice(-2),y=t[a-1],p=y.type;n={x:c[0],y:c[1]};let f,v,M,x,d={x:o[0],y:o[1]},g=Math.abs(n.x-u.x),b=Math.abs(n.y-u.y),m=(g+b)/2*h;switch(l){case"L":r=0===b||b<m&&g>m?{type:"H",values:[o[0]]}:0===g||b>m&&g<m?{type:"V",values:[o[1]]}:s;break;case"Q":if("Q"!==p){u={x:c[0],y:c[1]},i.push(s);continue}let t={x:y.values[0],y:y.values[1]};x={x:2*u.x-t.x,y:2*u.y-t.y},f=Math.abs(d.x-x.x),v=Math.abs(d.y-x.y),M=(f+v)/2,r=M<m?{type:"T",values:[n.x,n.y]}:s;break;case"C":let e={x:o[2],y:o[3]};if("C"!==p){i.push(s),u={x:c[0],y:c[1]};continue}let a={x:y.values[2],y:y.values[3]};x={x:2*u.x-a.x,y:2*u.y-a.y},f=Math.abs(d.x-x.x),v=Math.abs(d.y-x.y),M=(f+v)/2,r=M<m?{type:"S",values:[e.x,e.y,n.x,n.y]}:s;break;default:r={type:l,values:o}}(s.decimals||0===s.decimals)&&(r.decimals=s.decimals),e>-1&&(r.values=r.values.map((t=>+t.toFixed(e)))),u={x:c[0],y:c[1]},i.push(r)}return i}(t)),i&&(t=function(t,e=-1){e>=0&&(t[0].values=t[0].values.map((t=>+t.toFixed(e))));let a=t[0].values,s=a[0],l=a[1],r=s,n=l;for(let a=1,i=t.length;a<i;a++){let i=t[a];e>=0&&i.values.length&&(i.values=i.values.map((t=>+t.toFixed(e))));let{type:u,values:h}=i,o=u.toLowerCase();if(u!=o)switch(u=o,i.type=u,o){case"a":h[5]=+(h[5]-s),h[6]=+(h[6]-l);break;case"v":h[0]=+(h[0]-l);break;case"m":r=h[0],n=h[1];default:if(h.length)for(let t=0;t<h.length;t++)h[t]=h[t]-(t%2?l:s)}else"m"==u&&(r=h[0]+s,n=h[1]+l);let c=h.length;switch(u){case"z":s=r,l=n;break;case"h":s+=h[c-1];break;case"v":l+=h[c-1];break;default:s+=h[c-2],l+=h[c-1]}e>-1&&(i.values=i.values.map((t=>+t.toFixed(e))))}return t}(t)),-1!==b&&(t=e(t,b)),t},t.parse=function(t,e=!0){e="log";const a={77:2,109:2,65:7,97:7,67:6,99:6,72:1,104:1,76:2,108:2,81:4,113:4,83:4,115:4,84:2,116:2,86:1,118:1,90:0,122:0},s=new Set([77,109,65,97,67,99,72,104,76,108,81,113,83,115,84,116,86,118,90,122]),l=new Set([5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279]);let r,n=0,i=t.length,u="",h=[],o=-1,c="",y=!1,p=!1,f=0,v=0,M=0,x=!1,d=!1,g=!1,b=!1,m=!1,P=new Set(["m","c","q","l","a","t","s","v","h"]),A=new Set(["t","s","v","h","T","S","V","H"]),w=new Set(["t","q","T","Q"]),k=[];function q(){x&&("M"===u?u="L":"m"===u&&(u="l"),h.push({type:u,values:[]}),o++,v=0,x=!1)}function T(t=!1){(t?f>0:""!==c)&&(e&&-1===o&&(r="Pathdata must start with M command",k.push(r),u="M",h.push({type:u,values:[]}),M=2,v=0,o++),"A"===u||"a"===u?(c=function(){let t=c.length,e=!1;3===v&&2===t||4===v&&t>1?(c=[+c[0],+c[1]],e=!0,v++):3===v&&t>3&&(c=[+c[0],+c[1],+c.substring(2)],e=!0,v+=2);return e?c:[+c]}(),h[o].values.push(...c)):(e&&c[1]&&"."!==c[1]&&"0"===c[0]&&(r="Leading zeros not valid: "+c,k.push(r)),h[o].values.push(+c)),v++,c="",f=0,x=v>=M)}function I(){if(e){let t=o>0?h[o]:0,e=t?t.values.length:0;if(e&&e<M||e&&e>M||("z"===u||"Z"===u)&&e>0){r=`Pathdata commands in "${u}" (segment index: ${o}) don't match allowed number of values: ${M-e}/${M}`,k.push(r)}}}for(;n<i;){let e=t[n],r=t.charCodeAt(n);if($=r,s.has($)){""!==c&&(h[o].values.push(+c),v++,c=""),I(),u=e,M=a[r];let t="M"===u||"m"===u;o>0&&("z"===h[o].type||"Z"===h[o].type)&&!t&&(h.push({type:"m",values:[0,0]}),o++),h.push({type:u,values:[]}),o++,d||(d=P.has(u)),b||(b=A.has(u)),m||(m=w.has(u)),g||(g="a"===u||"A"===u),p=!1,f=0,v=0,x=!1,n++}else if(10===(Z=r)||13===Z||8232===Z||8233===Z||44===Z||44===Z||32===Z||9===Z||11===Z||12===Z||160===Z||Z>=5760&&l.has(Z)>=0)T(),p=!0,y=!1,n++;else{if(n===i-1){c+=e,T(),p=!1,y=!1,I();break}if(!y&&!p&&45===r||!y&&46===r){let t=46===r;T(t),q(),t&&f++}else q();c+=e,y=69===r||101===r,p=!1,n++}}var Z,$;return I(),e&&k.length&&(r="Invalid path data:\n"+k.join("\n"),console.log(r)),h[0].type="M",{pathData:h,hasRelatives:d,hasShorthands:b,hasQuadratics:m,hasArcs:g}},t.pathDataToD=function(t,e=1){let a=e>1,s=!a;"l"===t[1].type&&s&&(t[0].type="m");let l="";l=a?`${t[0].type} ${t[0].values.join(" ")}\n`:`${t[0].type}${t[0].values.join(" ")}`;for(let e=1,r=t.length;e<r;e++){let r=t[e-1],n=t[e],{type:i,values:u}=n;if(!s||"A"!==i&&"a"!==i||(u=[u[0],u[1],u[2],`${u[3]}${u[4]}${u[5]}`,u[6]]),i=r.type===n.type&&"m"!==n.type.toLowerCase()&&s||("m"===r.type&&"l"===n.type||"M"===r.type&&"l"===n.type||"M"===r.type&&"L"===n.type)&&s?" ":n.type,s){let t="",e=!1;for(let a=0,s=u.length;a<s;a++){let s=u[a],l=s.toString(),r=l.includes(".")&&Math.abs(s)<1;r&&e&&(l=l.replace(/^0\./,".")),!(a>0)||e&&r||(t+=" "),t+=l,e=r}l+=`${i}${t}`}else l+=a?`${i} ${u.join(" ")}\n`:`${i}${u.join(" ")}`}return s&&(l=l.replace(/ 0\./g," .").replace(/ -/g,"-").replace(/-0\./g,"-.").replace(/Z/g,"z")),l},t.roundPathData=e,t.svgArcToCenterParam=function(t,e,a,s,r,n,o,c,y){const f=(t,e,a,s)=>i(s-e,a-t);let M={cx:0,cy:0,rx:a=l(a),ry:s=l(s),startAngle:0,endAngle:0,deltaAngle:0,clockwise:o};if(0==a||0==s)throw Error("rx and ry can not be 0");if(a===s){let a=Math.abs(c-t),s=Math.abs(y-e),l=a,r=Math.min(t,c),n=Math.min(e,y),i=.5*Math.PI;if(0===a&&s||0===s&&a)return l=0===a&&s?s/2:a/2,M.rx=l,M.ry=l,0===a&&s?(M.cx=t,M.cy=n+s/2,M.startAngle=e>y?i:-i,M.endAngle=e>y?-i:i,M.deltaAngle=o?Math.PI:-Math.PI):0===s&&a&&(M.cx=r+a/2,M.cy=e,M.startAngle=t>c?Math.PI:0,M.endAngle=t>c?-Math.PI:Math.PI,M.deltaAngle=o?Math.PI:-Math.PI),M}let x,d,g=a===s?0:r*v/180,b=g?h(g):0,m=g?u(g):1,P=(t-c)/2,A=(e-y)/2,w=(t+c)/2,k=(e+y)/2,q=g?m*P+b*A:P,T=g?m*A-b*P:A,I=q*q/(a*a)+T*T/(s*s);I>1&&(a*=p(I),s*=p(I),M.rx=a,M.ry=s);let Z=a*s,$=a*T,D=s*q,C=$*$+D*D;if(!C)throw Error("start point can not be same as end point");let S=p(l((Z*Z-C)/C));n==o&&(S=-S);let X=S*$/s,Y=-S*D/a;x=g?m*X-b*Y+w:w+X,d=g?b*X+m*Y+k:k+Y,M.cy=d,M.cx=x;let F=f(x,d,t,e),L=f(x,d,c,y);!o&&L>F&&(L-=2*Math.PI),o&&F>L&&(L=L<=0?L+2*Math.PI:L);let j=L-F;return M.startAngle=F,M.endAngle=L,M.deltaAngle=j,M},t.transformPathData=function(t,e,a={x:0,y:0},s=1/0,l=-1){t=Array.isArray(t)?t:MatriXYZ.parse(t).pathData,t=MatriXYZ.convertPathData(t,{toAbsolute:!0,toLonghands:!0});let r=[],n=16===Object.values(e).length,i=!1;if(n&&(i=MatriXYZ.canFlattenTo2D(e,s)),i&&(n=!1,e=MatriXYZ.flattenTo2D(e,s)),n){let e={arcToCubic:!0};t=MatriXYZ.convertPathData(t,e)}return"100100"===[e.a,e.b,e.c,e.d,e.e,e.f].map((t=>+t.toFixed(1))).join("")?t:(t.forEach(((l,i)=>{let{type:u,values:h}=l,o=u.toLowerCase(),c=(i>0?t[i-1]:t[i]).values,y=c.length,p={x:c[y-2],y:c[y-1]};h[h.length-2],h[h.length-1];let f={type:u,values:[]};if("a"===o)f=((t,e,a)=>{let[s,l,r,n,i,u,h]=e,o=MatriXYZ.svgArcToCenterParam(t.x,t.y,e[0],e[1],r,n,i,u,h);({rx:s,ry:l}=o);let{a:c,b:y,c:p,d:f,e:v,f:M}=a,x=((t,e,a,s)=>{const l=Math.PI/180,r=1e-7;var n=Math.cos(a*l),i=Math.sin(a*l),u=[t*(s.a*n+s.c*i),t*(s.b*n+s.d*i),e*(-s.a*i+s.c*n),e*(-s.b*i+s.d*n)],h=u[0]*u[0]+u[2]*u[2],o=u[1]*u[1]+u[3]*u[3],c=Math.sqrt(((u[0]-u[3])*(u[0]-u[3])+(u[2]+u[1])*(u[2]+u[1]))*((u[0]+u[3])*(u[0]+u[3])+(u[2]-u[1])*(u[2]-u[1]))),y=(h+o)/2;if(c<=r)return{rx:t=e=Math.sqrt(y),ry:e,ax:a=0};if(Math.abs(c-Math.abs(h-o))<=r)return{rx:t=Math.sqrt(h),ry:e=Math.sqrt(o),ax:a=0};var p=u[0]*u[1]+u[2]*u[3],f=y+c/2,v=y-c/2;return Math.abs(p)<=r&&Math.abs(f-o)<=r?(a=0,{rx:t=Math.sqrt(v),ry:e=Math.sqrt(f),ax:a}):((a=Math.atan(Math.abs(p)>Math.abs(f-o)?(f-h)/p:p/(f-o))/l)>=0?(t=Math.sqrt(f),e=Math.sqrt(v)):(a+=90,t=Math.sqrt(v),e=Math.sqrt(f)),{rx:t,ry:e,ax:a})})(s,l,r,a),d=MatriXYZ.transformPoint2D({x:u,y:h},a),g=c**2+y**2,b=Math.sqrt(g);return(b<0||(c*f-p*y)/b<0)&&(i=0===i?1:0),{type:"A",values:[x.rx,x.ry,x.ax,n,i,d.x,d.y]}})(p,h,e);else if(h.length)for(let t=0;t<h.length;t+=2){let r=n?MatriXYZ.transformPoint3D({x:l.values[t],y:l.values[t+1]},e,a,s):MatriXYZ.transformPoint2D({x:l.values[t],y:l.values[t+1]},e);f.values[t]=r.x,f.values[t+1]=r.y}r.push(f)})),r)}}));
